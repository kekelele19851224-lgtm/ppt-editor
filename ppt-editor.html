<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PPT编辑器</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    .container { width: 100%; height: 100%; display: flex; flex-direction: column; }
    .topbar { 
      height: 44px; 
      background: #1a1a1a; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 0 12px;
      flex-shrink: 0;
    }
    .title { color: #fff; font-size: 16px; }
    .btn-back { 
      background: #3b82f6; 
      color: #fff; 
      border: none; 
      padding: 6px 12px; 
      border-radius: 4px; 
      font-size: 14px;
      cursor: pointer;
    }
    .content { flex: 1; width: 100%; overflow: hidden; }
    .iframe { width: 100%; height: 100%; border: none; }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 16px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <span class="title" id="title">生成PPT</span>
      <button class="btn-back" id="backBtn">返回小程序</button>
    </div>
    <div class="content" id="content">
      <div class="loading" id="loading">加载中...</div>
    </div>
  </div>

  <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <script>
    // 解析 URL 参数
    function getParams() {
      var params = {};
      var search = location.search.slice(1).split('&');
      for (var i = 0; i < search.length; i++) {
        if (!search[i]) continue;
        var pair = search[i].split('=');
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
      }
      return params;
    }

    var params = getParams();
    var token = params.token || '';
    var subject = params.subject || '';
    var templateId = params.templateId || '';
    var pptId = params.pptId || '';
    var mode = params.mode || 'create';

    // 设置标题
    document.getElementById('title').innerText = mode === 'edit' ? '编辑PPT' : '生成PPT';

    // 返回按钮
    document.getElementById('backBtn').onclick = function() {
      if (window.wx && wx.miniProgram && wx.miniProgram.navigateBack) {
        wx.miniProgram.navigateBack();
      } else {
        history.back();
      }
    };

    // 构建 iframe URL
    // 使用 Docmee 官方提供的 UI 嵌入方式
    var baseUrl = 'https://docmee.cn';
    var iframeUrl = '';

    if (mode === 'edit' && pptId) {
      // 编辑模式
      iframeUrl = baseUrl + '/p/' + pptId + '?token=' + encodeURIComponent(token);
    } else {
      // 创建模式 - 直接进入创建页面
      iframeUrl = baseUrl + '/create?token=' + encodeURIComponent(token);
      if (subject) {
        iframeUrl += '&subject=' + encodeURIComponent(subject);
      }
      if (templateId) {
        iframeUrl += '&templateId=' + encodeURIComponent(templateId);
      }
    }

    // 创建 iframe
    var content = document.getElementById('content');
    var iframe = document.createElement('iframe');
    iframe.className = 'iframe';
    iframe.src = iframeUrl;
    iframe.onload = function() {
      document.getElementById('loading').style.display = 'none';
    };
    content.innerHTML = '';
    content.appendChild(iframe);

    // 监听来自 iframe 的消息
    window.addEventListener('message', function(e) {
      if (!e || !e.data) return;
      var data = e.data;
      console.log('收到消息:', data);
      
      // 处理生成完成等事件
      if (data.type === 'generateComplete' || data.type === 'close') {
        if (window.wx && wx.miniProgram) {
          wx.miniProgram.navigateBack();
        }
      }
    });
  </script>
</body>
</html>