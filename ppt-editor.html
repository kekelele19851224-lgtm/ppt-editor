<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PPT编辑器</title>
  <script src="./docmee-ui-sdk-iframe.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    .container { width: 100%; height: 100%; display: flex; flex-direction: column; }
    .topbar { 
      height: 44px; 
      background: #1a1a1a; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 0 12px;
      flex-shrink: 0;
    }
    .title { color: #fff; font-size: 16px; }
    .btn-back { 
      background: #3b82f6; 
      color: #fff; 
      border: none; 
      padding: 6px 12px; 
      border-radius: 4px; 
      font-size: 14px;
      cursor: pointer;
    }
    #ppt-container { 
      flex: 1; 
      width: 100%; 
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <span class="title" id="title">生成PPT</span>
      <button class="btn-back" id="backBtn">返回小程序</button>
    </div>
    <div id="ppt-container"></div>
  </div>

  <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <script>
    // 解析 URL 参数
    function getParams() {
      var params = {};
      var search = location.search.slice(1).split('&');
      for (var i = 0; i < search.length; i++) {
        if (!search[i]) continue;
        var pair = search[i].split('=');
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
      }
      return params;
    }

    var params = getParams();
    var token = params.token || '';
    var subject = params.subject || '';
    var templateId = params.templateId || '';
    var pptId = params.pptId || '';
    var mode = params.mode || 'create';

    // 设置标题
    document.getElementById('title').innerText = mode === 'edit' ? '编辑PPT' : '生成PPT';

    // 返回按钮
    document.getElementById('backBtn').onclick = function() {
      if (window.wx && wx.miniProgram && wx.miniProgram.navigateBack) {
        wx.miniProgram.navigateBack();
      } else {
        history.back();
      }
    };

    // 初始化 DocmeeUI
    if (typeof DocmeeUI !== 'undefined' && token) {
      var docmeeUI = new DocmeeUI({
        token: token,
        container: document.querySelector('#ppt-container'),
        page: mode === 'edit' ? 'editor' : 'creator',
        pptId: mode === 'edit' ? pptId : null,
        lang: 'zh',
        mode: 'light',
        isMobile: true,
        background: '#ffffff',
        padding: '0',
        onMessage: function(message) {
          console.log('DocmeeUI message:', message);
          if (message.type === 'invalid-token') {
            console.log('Token 失效');
            alert('登录已过期，请返回重试');
          } else if (message.type === 'error') {
            console.log('错误:', message.data);
            if (message.data && message.data.message) {
              alert(message.data.message);
            }
          }
        }
      });

      // 如果是创建模式且有主题，自动填入主题
      if (mode === 'create' && subject) {
        setTimeout(function() {
          docmeeUI.changeCreatorData && docmeeUI.changeCreatorData({ subject: subject }, false);
        }, 1000);
      }
    } else if (!token) {
      document.getElementById('ppt-container').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">缺少 token 参数</div>';
    } else {
      document.getElementById('ppt-container').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">SDK 加载失败</div>';
    }
  </script>
</body>
</html>
